<!---
eChronos Real-Time Operating System
Copyright (C) 2017  National ICT Australia Limited (NICTA), ABN 62 102 206 173.

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as published by
the Free Software Foundation, version 3, provided that these additional
terms apply under section 7:

  No right, title or interest in or to any trade mark, service mark, logo
  or trade name of of National ICT Australia Limited, ABN 62 102 206 173
  ("NICTA") or its licensors is granted. Modified versions of the Program
  must be plainly marked as such, and must not be distributed using
  "eChronos" as a trade mark or product name, or misrepresented as being
  the original Program.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.

@TAG(NICTA_DOC_AGPL)
  -->
# Common Development Tasks

## Developing a RTOS variant

To generate the code for all available RTOS variants:

    ./x.py build packages

The resulting RTOS code is placed into `packages/<platform>/rtos-<variant>/`.

The RTOS variants themselves are specified as lists of components within `x.py` itself.
Adding a new RTOS variant means adding the appropriate list entries to `x.py`, and adding new component code in the `components` directory structure if necessary.

Please see the existing component code under [`components`](../components) for examples on how to develop RTOS components.


## Building user documentation

Manuals for the main RTOS variants are built with the command `./x.py build docs`.
On Linux, this depends on the tools _wkhtmltopdf_ and _pandoc_ to be installed.

The manuals are created in `packages/<platform>/rtos-<variant>/documentation.*` in HTML, Markdown, and PDF.

Like the RTOS component code, the user manual content is componentized so that only the user documentation for components present in a particular RTOS variant appears in the user manual for that variant.

See `components/*/docs.md` for examples of componentized user documentation.


## Building the `prj` tool

To build just the `prj` tool binary for stand-alone use:

    # The `prj` binary is output to `prj_build_x86_64-unknown-linux-gnu/prj`
    ./x.py build prj


## Configuring and building a system

To build a system, use the `prj build` sub-tool of `prj`, supplying the system name as argument.
The name of the system is the basename of its `.prx` file, minus its `.prx` extension, appended to a dot-separated string indicating the sub-package location in which it can be found.

For example, to build the system whose `.prx` file is located at [`packages/machine-qemu-ppce500/example/kochab-timer-demo.prx`](../packages/machine-qemu-ppce500/example/kochab-timer-demo.prx), from the top level of the repository:

    prj/app/prj.py build machine-qemu-ppce500.example.kochab-timer-demo

Alternatively, assuming the `prj` tool binary is on the PATH:

    prj build machine-qemu-ppce500.example.kochab-timer-demo


## Building a product release

To build all product releases, run:

    ./x.py build prj
    ./x.py build docs
    ./x.py build partials
    ./x.py build release

The releases are defined in the top-level [`release_cfg.py`](../release_cfg.py) script and are generated by `x.py` into `release/*.tar.gz`.

Each product release contains:

* a `LICENSE` file
* a `README.md` file containing a brief introduction to the release
* a `build_info` file containing the commit hash of the RTOS repository from which the release was built
* a `share` directory, containing the package directory structure containing all the released packages
* a pre-built `prj` binary for the host platform targeted by the release

Note that any user manuals available for each RTOS variant in the release can be found at `share/packages/<platform>/rtos-<variant>/documentation.*` in HTML, Markdown and PDF.


## Using a product release

After unpacking the product release, create a `project.prj` file for your software project in order to be able to use the `prj` tool that comes packaged with the release.

A minimal `project.prj` contains, at the very least, a `search-path` entry to give `prj` a hint as to where to find modules.
Here is a example that points to its relative location from the root of the release:

    <?xml version="1.0" encoding="UTF-8" ?>
    <project>
        <search-path>share/packages</search-path>
    </project>

After this, the `prj` binary packaged with the release can be used in the same way as in the RTOS repository.
Additional application code can be placed in other directories as long as they are included as search paths in the project.prj file.

For example, to build the Kochab timer demo system provided with the PowerPC e500 release of the RTOS for Linux, run:

    x86_64-unknown-linux-gnu/bin/prj build machine-qemu-ppce500.example.kochab-timer-demo

Note that the PATH environment variable needs to be set up manually so that it includes the tools invoked by `prj`.
